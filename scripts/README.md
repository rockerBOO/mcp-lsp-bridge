# MCP External Testing Scripts

This directory contains scripts for testing the MCP-LSP Bridge server externally, simulating how Claude Code would interact with the MCP server.

## Available Scripts

### 1. Python Test Script (Recommended)
- **File**: `test_mcp_external.py`
- **Description**: Comprehensive Python-based external MCP testing
- **Usage**: `python3 test_mcp_external.py` or `make test-mcp-external`

**Features:**
- JSON-RPC communication with MCP server
- Comprehensive test coverage for all MCP tools
- Detailed error handling and reporting
- Colored terminal output
- JSON report generation
- Automatic cleanup

### 2. MCP Tools Test
- **File**: `test_mcp_tools.py`
- **Description**: Individual MCP tools functionality test
- **Usage**: `python3 test_mcp_tools.py` or `make test-mcp-tools`

**Features:**
- Tests each MCP tool individually
- Validates tool responses
- Comprehensive functionality verification

### 3. Performance Test
- **File**: `performance_test.py`
- **Description**: Performance testing for analysis functionality
- **Usage**: `uv run python scripts/performance_test.py`

**Features:**
- Tests various analysis types with different complexity levels
- Measures execution duration and response sizes
- Validates all analysis operations (file, workspace, symbols, patterns)
- Identifies slow operations and performance bottlenecks
- 100% success rate validation

### 4. Memory Test
- **File**: `memory_test.py`
- **Description**: Memory usage monitoring for analysis operations
- **Usage**: `uv run python scripts/memory_test.py`

**Features:**
- Monitors memory consumption during analysis operations
- Tracks baseline, peak, and final memory usage
- Detects memory leaks and high usage patterns
- No external dependencies (uses built-in `resource` module)
- System memory info display on Linux

### 5. Advanced MCP Test
- **File**: `mcp_external_test.py`
- **Description**: Advanced testing framework with command parsing and variable interpolation
- **Usage**: `uv run python scripts/mcp_external_test.py`

**Features:**
- Complex command parsing with variable interpolation
- Context preservation between tests
- Advanced testing scenarios
- Sophisticated error handling

### 6. Hover Optimization Test
- **File**: `test_hover_optimization.py`
- **Description**: Demonstrates hover optimization workflow patterns
- **Usage**: `uv run python scripts/test_hover_optimization.py`

**Features:**
- Document symbols â†’ hover refinement workflow
- Optimal hover position detection
- Known issue workarounds
- Workflow pattern demonstration

### 7. New Tools Test
- **File**: `test_new_tools.py`
- **Description**: Tests newly fixed implementation and signature help tools
- **Usage**: `uv run python scripts/test_new_tools.py`

**Features:**
- Specific tool validation
- Error handling demonstration
- Fixed tool functionality testing
- Regression testing

## Test Coverage

The external tests cover the following MCP tools:

1. **Initialize**: MCP connection initialization
2. **List Tools**: Enumerate available MCP tools
3. **Infer Language**: Test language detection for files
4. **LSP Connect**: Test language server connection
5. **Analyze Code**: Test code analysis functionality
6. **LSP Disconnect**: Test cleanup and disconnection

## Requirements

### Python Script
- Python 3.6+
- Standard library only (no external dependencies)

### Shell Script
- Bash 4.0+
- `nc` (netcat)
- `bc` (basic calculator)
- `timeout` command

### Go Script
- Go 1.19+
- MCP-Go library

## Usage Examples

```bash
# Run individual tools test (primary development tool)
make test-mcp-tools

# Run comprehensive external tests
make test-mcp-external

# Run performance tests
uv run python scripts/performance_test.py

# Run memory tests
uv run python scripts/memory_test.py

# Run tests directly
cd scripts
python3 test_mcp_tools.py
python3 test_mcp_external.py
uv run python performance_test.py
uv run python memory_test.py
uv run python mcp_external_test.py
uv run python test_hover_optimization.py
uv run python test_new_tools.py
```

## Output Files

- **Report File**: `mcp_test_report.json` - JSON test report with results (generated by comprehensive tests)

## Test Results

Each test produces:
- **Success/Failure status**
- **Execution duration**
- **Error messages** (if any)
- **Server responses** (in JSON report)

## Integration with CI/CD

The tests are designed to be CI/CD friendly:
- Return appropriate exit codes (0 = success, 1 = failure)
- Generate machine-readable JSON reports
- Provide colored output for human readability
- Include timeout handling to prevent hanging

## Troubleshooting

### Common Issues

1. **Build Failures**
   - Ensure Go is installed and in PATH
   - Run `go mod tidy` in project root

2. **Server Start Failures**
   - Check if required LSP servers are installed
   - Review log file for detailed error messages

3. **Connection Issues**
   - Ensure no other process is using the same port
   - Check firewall settings

4. **Timeout Issues**
   - Increase timeout values in scripts
   - Check system performance

### Debug Mode

For debugging, check the log file:
```bash
tail -f scripts/mcp_test.log
```

## Contributing

When adding new tests:
1. Follow the existing test pattern
2. Add appropriate error handling
3. Update this README
4. Ensure cross-platform compatibility